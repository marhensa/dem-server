<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marhensa DEM Server - MapLibre GL JS</title>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.17.0/dist/maplibre-gl.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; }

        #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }

        /* Status panel */
        #status {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 14px 18px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            width: 260px;
            max-width: calc(50vw - 40px);
            backdrop-filter: blur(8px);
        }
        #status h3 { margin: 10px 0 5px; font-size: 14px; color: #7dd3fc; border-bottom: 1px solid rgba(125, 211, 252, 0.3); padding-bottom: 4px; }
        #status h3:first-child { margin-top: 0; }
        #status .row { display: flex; flex-direction: column; gap: 2px; margin-bottom: 6px; }
        #status .row select { width: 100%; max-width: 100%; box-sizing: border-box; }
        #status .label { color: #94a3b8; flex-shrink: 0; }
        #status .val { color: #e2e8f0; font-family: monospace; }

        /* Responsive: smaller font on narrow screens */
        @media (max-width: 500px) {
            #status, #controls { font-size: 11px; padding: 10px 12px; }
            #status h3, #controls h3 { font-size: 12px; }
            #controls input[type="range"] { width: 100px; }
            #controls .range-val { display: none; }
        }
        #status .ok { color: #4ade80; }
        #status .err { color: #f87171; }
        #status .loading { color: #fbbf24; }

        /* Controls panel */
        #controls {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 14px 18px;
            border-radius: 8px;
            font-size: 13px;
            max-width: calc(50vw - 40px);
            backdrop-filter: blur(8px);
        }
        #controls h3 { margin: 0 0 10px; font-size: 14px; color: #7dd3fc; }
        #controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        #controls input[type="range"] {
            width: 140px;
            accent-color: #7dd3fc;
        }
        #controls .range-val {
            font-family: monospace;
            color: #e2e8f0;
            min-width: 32px;
            text-align: right;
        }
        #controls .control-group { opacity: 1; transition: opacity 0.2s; }
        #controls .control-group.disabled { opacity: 0.35; pointer-events: none; }

        /* Coordinate bar (bottom-right) */
        #coords {
            position: absolute;
            bottom: 8px;
            right: 8px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            color: #e2e8f0;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            backdrop-filter: blur(8px);
        }

        /* Data source footer (above coords, below nav controls) */
        #footer {
            position: absolute;
            bottom: 36px;
            right: 8px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            color: rgba(255,255,255,0.7);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-align: right;
            pointer-events: none;
        }

        /* Hide default MapLibre attribution */
        .maplibregl-ctrl-attrib {
            display: none !important;
        }

        /* Move nav controls up to make room for footer and coords */
        .maplibregl-ctrl-bottom-right {
            bottom: 58px !important;
        }

        /* Slope legend */
        #slope-legend {
            display: none;
            margin-top: 6px;
            padding: 6px 0 0;
            border-top: 1px solid rgba(255,255,255,0.15);
        }
        #slope-legend .legend-bar {
            height: 10px;
            border-radius: 3px;
            background: linear-gradient(to right, #2d6a4f, #74c69d, #ffdd57, #ff8c00, #d00000);
        }
        #slope-legend .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #94a3b8;
            margin-top: 2px;
        }

        /* Panel collapse functionality */
        #status, #controls {
            position: absolute;
            transition: width 0.3s ease, height 0.3s ease, padding 0.3s ease;
        }
        .panel-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(125, 211, 252, 0.2);
            border: 1px solid rgba(125, 211, 252, 0.4);
            border-radius: 4px;
            color: #7dd3fc;
            cursor: pointer;
            font-size: 14px;
            line-height: 22px;
            text-align: center;
            z-index: 11;
            padding: 0;
        }
        .panel-toggle:hover {
            background: rgba(125, 211, 252, 0.4);
        }
        #status.collapsed, #controls.collapsed {
            width: 40px !important;
            height: 40px !important;
            padding: 8px;
            overflow: hidden;
        }
        #status.collapsed > *:not(.panel-toggle),
        #controls.collapsed > *:not(.panel-toggle) {
            display: none;
        }
        #status.collapsed .panel-toggle,
        #controls.collapsed .panel-toggle {
            position: static;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Status panel -->
    <div id="status">
        <button class="panel-toggle" id="toggle-status" title="Collapse panel">‹</button>
        <h3 id="viewer-title">DEM Terrain:<br><span id="viewer-region">Integrated</span></h3>
        <div class="row">
            <span class="label">Region</span>
            <select id="region-selector" style="background: #1e293b; color: #fff; border: 1px solid #475569; border-radius: 4px; font-size: 12px; padding: 2px 4px; cursor: pointer;">
                <option value="">Integrated (All Regions)</option>
                <option value="sumatra">Sumatra</option>
                <option value="jawa">Jawa</option>
                <option value="balinusra">Balinusra</option>
                <option value="kalimantan">Kalimantan</option>
                <option value="sulawesi">Sulawesi</option>
                <option value="maluku">Maluku</option>
                <option value="papua">Papua</option>
            </select>
        </div>
        <div class="row">
            <span class="label">TiTiler Hub</span>
            <span id="titiler-status" class="val loading">checking...</span>
        </div>
        <div class="row">
            <span class="label">Elevation range</span>
            <span id="cog-elev" class="val">--</span>
        </div>
        <div class="row">
            <span class="label">Cursor elev.</span>
            <span id="cursor-elev" class="val">--</span>
        </div>
        <div class="row">
            <span class="label" id="source-label">Source</span>
            <span id="cog-size" class="val">--</span>
        </div>
        <h3>Current Camera View</h3>
        <div class="row">
            <span class="label">Longitude</span>
            <span id="cam-lon" class="val">--</span>
        </div>
        <div class="row">
            <span class="label">Latitude</span>
            <span id="cam-lat" class="val">--</span>
        </div>
        <div class="row">
            <span class="label">Zoom</span>
            <span id="cam-zoom" class="val">--</span>
        </div>
        <div class="row">
            <span class="label">Bearing</span>
            <span id="cam-bearing" class="val">--</span>
        </div>
        <div class="row">
            <span class="label">Pitch</span>
            <span id="cam-pitch" class="val">--</span>
        </div>
    </div>

    <!-- Controls panel -->
    <div id="controls">
        <button class="panel-toggle" id="toggle-controls" title="Collapse panel">›</button>
        <h3>Controls</h3>
        <label>
            <input type="checkbox" id="toggle-terrain" checked>
            <span>3D Terrain</span>
        </label>
        <label>
            <input type="range" id="exaggeration" min="0.5" max="5" step="0.1" value="1.0">
            <span class="range-val" id="exag-val">1.0</span>
        </label>
        <div id="titiler-overlays" class="control-group">
            <label>
                <input type="checkbox" id="toggle-hillshade">
                <span>Hillshade layer</span>
            </label>
            <label>
                <input type="range" id="hillshade-opacity" min="0" max="1" step="0.05" value="0.5" disabled>
                <span class="range-val" id="hs-opacity-val">0.5</span>
            </label>
            <label>
                <input type="checkbox" id="toggle-contours" checked>
                <span>Contour lines</span>
            </label>
            <label>
                <input type="range" id="contour-opacity" min="0" max="1" step="0.05" value="1.0">
                <span class="range-val" id="ct-opacity-val">1.0</span>
            </label>
            <label>
                <input type="checkbox" id="toggle-slope">
                <span>Slope analysis</span>
            </label>
            <label>
                <input type="range" id="slope-opacity" min="0" max="1" step="0.05" value="0.6" disabled>
                <span class="range-val" id="sl-opacity-val">0.6</span>
            </label>
            <div id="slope-legend">
                <div class="legend-bar"></div>
                <div class="legend-labels">
                    <span>0° Flat</span>
                    <span>22°</span>
                    <span>45°</span>
                    <span>67°</span>
                    <span>90° Cliff</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Coordinate bar -->
    <div id="coords">--</div>

    <!-- Data source footer -->
    <div id="footer">Marhensa | Badan Informasi Geospasial DEM | TiTiler | MapLibre GL</div>

    <script src="https://unpkg.com/maplibre-gl@5.17.0/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/maplibre-contour@0.1.0/dist/index.min.js"></script>
    <script>
    // =========================================================================
    // Suppress expected 404 errors from TiTiler (tiles outside bounds)
    // =========================================================================
    const originalConsoleError = console.error;
    const originalConsoleWarn = console.warn;
    
    function isTileError(arg) {
        if (!arg) return false;
        const str = arg instanceof Error ? arg.message : String(arg);
        return str.includes('localhost:3333') || str.includes('localhost:8000') || 
               str.includes('titiler/cog/tiles') || str.includes('titiler/mosaic/tiles');
    }
    
    console.error = function(...args) {
        if (args.some(isTileError)) return;
        originalConsoleError.apply(console, args);
    };
    console.warn = function(...args) {
        if (args.some(isTileError)) return;
        originalConsoleWarn.apply(console, args);
    };
    </script>
    <script>
    // =========================================================================
    // Configuration
    // =========================================================================
    const PROXY_BASE   = window.location.origin;
    const TITILER_BASE = `${PROXY_BASE}/titiler`;
    
    // Dynamic Region Support
    const params = new URLSearchParams(window.location.search);
    // Default is 'sulawesi' if region param is missing
    const REGION = params.has('region') ? params.get('region') : 'sulawesi';
    
    document.getElementById('region-selector').value = REGION;
    document.getElementById('region-selector').onchange = (e) => {
        window.location.search = `?region=${e.target.value}`;
    };

    // For both National and Regional, we use the Mosaic endpoints
    const MOSAIC_PATH = REGION ? `file:///data/mosaic_${REGION}.json` : 'file:///data/mosaic.json';

    if (REGION) {
        document.getElementById('viewer-region').textContent = REGION.toUpperCase();
    } else {
        document.getElementById('viewer-region').textContent = "Integrated";
    }

    // Tile URLs
    // TiTiler 1.1.1 mosaic parameters for MapLibre 5.x
    // Synchronizing strictly on 256px to eliminate dimension mismatch
    // nodata=0 tells the reader to treat 0 as null; nodata_height:0 tells the encoder to map null to 0m
    const ALGO_PARAMS = encodeURIComponent(JSON.stringify({ nodata_height: 0 }));
    const HUB_PARAMS  = `&tilesize=256&nodata=0`; 
    
    const TERRAIN_RGB_URL = `${TITILER_BASE}/mosaic/tiles/WebMercatorQuad/{z}/{x}/{y}.png?url=${MOSAIC_PATH}&algorithm=terrainrgb&algorithm_params=${ALGO_PARAMS}${HUB_PARAMS}&resampling_method=nearest`;
    const HILLSHADE_URL   = `${TITILER_BASE}/mosaic/tiles/WebMercatorQuad/{z}/{x}/{y}.png?url=${MOSAIC_PATH}&algorithm=hillshade${HUB_PARAMS}&resampling_method=bilinear`;
    const SLOPE_URL       = `${TITILER_BASE}/mosaic/tiles/WebMercatorQuad/{z}/{x}/{y}.png?url=${MOSAIC_PATH}&algorithm=slope&colormap_name=rdylgn_r${HUB_PARAMS}&resampling_method=bilinear`;

    // Specific POC Coordinates for Manado
    const POC_VIEW = { center: [124.930315, 1.442984], zoom: 17, bearing: 74.94, pitch: 60 };
    const INDONESIA_VIEW = { center: [118, -2], zoom: 4, pitch: 0, bearing: 0 };

    const initialView = (REGION === 'sulawesi') ? POC_VIEW : INDONESIA_VIEW;

    // Client-side contour generation
    const demSource = new mlcontour.DemSource({
        url: TERRAIN_RGB_URL,
        encoding: 'mapbox',
        minzoom: 13,
        maxzoom: 17, // Capped to 17 for contour snappiness
        tileSize: 256,
        worker: true,
        cacheSize: 20, // Reduced from 100 to throttle concurrent VPS requests
        timeoutMs: 10000
    });
    demSource.setupMaplibre(maplibregl);

    async function checkTiTiler() {
        const statusEl = document.getElementById('titiler-status');
        const elevEl   = document.getElementById('cog-elev');
        const sizeEl   = document.getElementById('cog-size');

        try {
            const res = await fetch(`${TITILER_BASE}/mosaic/info?url=${MOSAIC_PATH}`, {
                signal: AbortSignal.timeout(5000)
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const info = await res.json();

            statusEl.textContent = 'connected';
            statusEl.className = 'val ok';
            sizeEl.textContent = REGION ? `${REGION.toUpperCase()} Index` : 'Integrated Mosaic';
            elevEl.textContent = REGION ? `Dynamic (${REGION.toUpperCase()})` : 'Dynamic (Integrated)';
            return true;
        } catch (err) {
            statusEl.textContent = 'unreachable';
            statusEl.className = 'val err';
            console.warn('TiTiler Mosaic check failed:', err.message);
            return false;
        }
    }

    async function init() {
        const titilerOk = await checkTiTiler();
        if (!titilerOk) {
            document.getElementById('titiler-overlays').classList.add('disabled');
        }

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'esri-imagery': {
                        type: 'raster',
                        tiles: ['https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256,
                        attribution: '&copy; <a href="https://www.esri.com/">Esri</a>',
                        maxzoom: 19
                    }
                },
                layers: [{ id: 'esri-imagery-tiles', type: 'raster', source: 'esri-imagery', maxzoom: 22 }]
            },
            ...initialView,
            maxPitch: 85
        });

        map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'bottom-right');
        map.addControl(new maplibregl.ScaleControl(), 'bottom-left');

        map.on('load', () => {
            map.addSource('local-dem', {
                type: 'raster-dem',
                tiles: [TERRAIN_RGB_URL],
                tileSize: 256,
                encoding: 'mapbox',
                minzoom: 13,
                maxzoom: 17  // Aligned with 0.97m DEMNAS native resolution
            });

            map.setTerrain({ source: 'local-dem', exaggeration: 1.0 });

            map.addSource('local-hillshade', {
                type: 'raster',
                tiles: [HILLSHADE_URL],
                tileSize: 256,
                minzoom: 13,
                maxzoom: 17 // Capped to 17 to keep VPS snappier
            });

            map.addLayer({
                id: 'hillshade-layer',
                type: 'raster',
                source: 'local-hillshade',
                paint: { 'raster-opacity': 0.5 },
                layout: { visibility: 'none' }
            });

            map.addSource('local-slope', {
                type: 'raster',
                tiles: [SLOPE_URL],
                tileSize: 256,
                minzoom: 13,
                maxzoom: 17 // Capped to 17 for server performance
            });

            map.addLayer({
                id: 'slope-layer',
                type: 'raster',
                source: 'local-slope',
                paint: { 'raster-opacity': 0.6 },
                layout: { visibility: 'none' }
            });

            map.addSource('contour-source', {
                type: 'vector',
                tiles: [
                    demSource.contourProtocolUrl({
                        multiplier: 1,
                        thresholds: {
                            11: [20, 100], 12: [10, 50], 13: [10, 50],
                            14: [5, 25], 15: [5, 25], 16: [2, 10], 17: [1, 5], 18: [1, 5]
                        },
                        contourLayer: 'contours',
                        elevationKey: 'ele', levelKey: 'level', extent: 4096, buffer: 1
                    })
                ],
                minzoom: 13,
                maxzoom: 17 // Optimized for contour generation snappiness
            });

            map.addLayer({
                id: 'contour-lines',
                type: 'line',
                source: 'contour-source',
                'source-layer': 'contours',
                layout: { visibility: 'visible' },
                paint: {
                    'line-color': 'rgba(220, 38, 38, 0.8)',
                    'line-opacity': 1.0,
                    'line-width': ['match', ['get', 'level'], 1, 1.5, 0.6]
                }
            });

            map.addLayer({
                id: 'contour-labels',
                type: 'symbol',
                source: 'contour-source',
                'source-layer': 'contours',
                filter: ['>', ['get', 'level'], 0],
                layout: {
                    visibility: 'visible',
                    'symbol-placement': 'line',
                    'text-size': 10,
                    'text-field': ['concat', ['number-format', ['get', 'ele'], {}], 'm'],
                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold']
                },
                paint: {
                    'text-color': 'rgba(220, 38, 38, 1)',
                    'text-opacity': 1.0,
                    'text-halo-color': 'rgba(255, 255, 255, 0.9)',
                    'text-halo-width': 1.5
                }
            });

            // Controls wiring
            document.getElementById('toggle-terrain').addEventListener('change', (e) => {
                map.setTerrain(e.target.checked ? { source: 'local-dem', exaggeration: parseFloat(document.getElementById('exaggeration').value) } : null);
            });

            document.getElementById('exaggeration').addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                document.getElementById('exag-val').textContent = val.toFixed(1);
                if (document.getElementById('toggle-terrain').checked) {
                    map.setTerrain({ source: 'local-dem', exaggeration: val });
                }
            });

            document.getElementById('toggle-hillshade').addEventListener('change', (e) => {
                map.setLayoutProperty('hillshade-layer', 'visibility', e.target.checked ? 'visible' : 'none');
                document.getElementById('hillshade-opacity').disabled = !e.target.checked;
            });

            document.getElementById('hillshade-opacity').addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                document.getElementById('hs-opacity-val').textContent = val.toFixed(2);
                map.setPaintProperty('hillshade-layer', 'raster-opacity', val);
            });

            document.getElementById('toggle-contours').addEventListener('change', (e) => {
                const visibility = e.target.checked ? 'visible' : 'none';
                map.setLayoutProperty('contour-lines', 'visibility', visibility);
                map.setLayoutProperty('contour-labels', 'visibility', visibility);
            });

            document.getElementById('contour-opacity').addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                document.getElementById('ct-opacity-val').textContent = val.toFixed(2);
                map.setPaintProperty('contour-lines', 'line-opacity', val);
                map.setPaintProperty('contour-labels', 'text-opacity', val);
            });

            document.getElementById('toggle-slope').addEventListener('change', (e) => {
                map.setLayoutProperty('slope-layer', 'visibility', e.target.checked ? 'visible' : 'none');
                document.getElementById('slope-opacity').disabled = !e.target.checked;
                document.getElementById('slope-legend').style.display = e.target.checked ? 'block' : 'none';
            });

            document.getElementById('slope-opacity').addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                document.getElementById('sl-opacity-val').textContent = val.toFixed(2);
                map.setPaintProperty('slope-layer', 'raster-opacity', val);
            });

            const cursorElevEl = document.getElementById('cursor-elev');
            const coordsEl     = document.getElementById('coords');

            map.on('mousemove', (e) => {
                const { lng, lat } = e.lngLat;
                const elev = map.queryTerrainElevation(e.lngLat);
                if (elev !== null && elev !== undefined) {
                    cursorElevEl.textContent = `${elev.toFixed(1)}m`;
                    coordsEl.textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)} | ${elev.toFixed(1)}m`;
                } else {
                    cursorElevEl.textContent = '--';
                    coordsEl.textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                }
            });

            const updateCameraReadout = () => {
                const center = map.getCenter();
                document.getElementById('cam-lon').textContent = center.lng.toFixed(6);
                document.getElementById('cam-lat').textContent = center.lat.toFixed(6);
                document.getElementById('cam-zoom').textContent = map.getZoom().toFixed(2);
                document.getElementById('cam-bearing').textContent = map.getBearing().toFixed(2);
                document.getElementById('cam-pitch').textContent = map.getPitch().toFixed(2);
                // Update coords bar with center when no mouse position available
                if (coordsEl.textContent === '--') {
                    coordsEl.textContent = `${center.lat.toFixed(5)}, ${center.lng.toFixed(5)}`;
                }
            };
            map.on('move', updateCameraReadout);
            updateCameraReadout();
        });

        map.on('error', (e) => {
            if (e.error && e.error.message && e.error.message.includes('404')) return;
            console.warn('Map error:', e.error ? e.error.message : e);
        });

        // Panel collapse functionality
        setupPanelCollapse();
    }

    function setupPanelCollapse() {
        const statusPanel = document.getElementById('status');
        const controlsPanel = document.getElementById('controls');
        const toggleStatus = document.getElementById('toggle-status');
        const toggleControls = document.getElementById('toggle-controls');

        toggleStatus.onclick = () => {
            statusPanel.classList.toggle('collapsed');
            toggleStatus.textContent = statusPanel.classList.contains('collapsed') ? '›' : '‹';
        };

        toggleControls.onclick = () => {
            controlsPanel.classList.toggle('collapsed');
            toggleControls.textContent = controlsPanel.classList.contains('collapsed') ? '‹' : '›';
        };

        function checkPanelOverlap() {
            // Only check if panels are not already collapsed
            const statusCollapsed = statusPanel.classList.contains('collapsed');
            const controlsCollapsed = controlsPanel.classList.contains('collapsed');
            
            if (statusCollapsed && controlsCollapsed) return;

            const statusRect = statusPanel.getBoundingClientRect();
            const controlsRect = controlsPanel.getBoundingClientRect();
            const gap = 20;

            if (statusRect.right + gap > controlsRect.left) {
                if (!statusCollapsed) {
                    statusPanel.classList.add('collapsed');
                    toggleStatus.textContent = '›';
                }
                if (!controlsCollapsed) {
                    controlsPanel.classList.add('collapsed');
                    toggleControls.textContent = '‹';
                }
            }
        }

        window.addEventListener('resize', checkPanelOverlap);
        checkPanelOverlap();
    }

    init();
    </script>
</body>
</html>
