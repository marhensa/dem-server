# =============================================================================
# Integrated DEM Server - Docker Compose
#
# Services:
#   png-terrain-server-hub       - Terrain-RGB PNG tiles for MapLibre / Leaflet
#   quantized-mesh-server-hub    - Virtual Mesh Compositor for CesiumJS
#   viewer-gateway               - Central Nginx hub & test pages (port 3333)
# =============================================================================

services:
  # 1. PNG Terrain Server Hub (MapLibre / Leaflet)
  png-terrain-server-hub:
    image: ghcr.io/developmentseed/titiler:1.1.1
    container_name: png-terrain-server-hub
    volumes:
      - ./data:/data:ro
      - ./scripts:/scripts:ro
    command:
      - uvicorn
      - scripts.png_terrain_hub:app
      - --host
      - "0.0.0.0"
      - --port
      - "8000"
      - --workers
      - "2"
    environment:
      - PYTHONPATH=/
      - CPL_TMPDIR=/tmp
      - GDAL_CACHEMAX=75%
      - VSI_CACHE=TRUE
      - VSI_CACHE_SIZE=536870912
      - TITILER_API_CORS_ORIGINS=*
    restart: unless-stopped

  # 2. Quantized Mesh Server Hub (CesiumJS)
  quantized-mesh-server-hub:
    image: ghcr.io/developmentseed/titiler:1.1.1
    container_name: quantized-mesh-server-hub
    volumes:
      - ./data:/data:ro
      - ./scripts:/scripts:ro
    command:
      - uvicorn
      - scripts.mesh_terrain_hub:app
      - --host
      - "0.0.0.0"
      - --port
      - "8001"
    environment:
      - PYTHONPATH=/
    restart: unless-stopped

  # 3. Viewer Gateway (Nginx Hub)
  viewer-gateway:
    image: nginx:alpine
    container_name: viewer-gateway
    ports:
      - "3333:80"
    volumes:
      - ./test:/usr/share/nginx/html:ro
      - ./data/tiles:/data/tiles:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
