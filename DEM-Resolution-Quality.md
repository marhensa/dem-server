# DEM Resolution & Quality Tracking

This document tracks resolution settings across the DEM server pipeline.
Update these values when switching DEM sources.

---

## Current DEM Source

| Property | Value |
|----------|-------|
| **Name** | New BIG DEM (Unreleased) |
| **Provider** | Badan Informasi Geospasial (BIG) |
| **Native Resolution** | 0.997m (0.00000895461°) |
| **Recommended Max Zoom** | 17 (1.19m/pixel) |

---

## Zoom Level Reference (Equatorial Indonesia)

Web Mercator projection, 256px tiles, at equator (~0° latitude):

| Zoom | Meters/Pixel | Tile Coverage |
|------|--------------|---------------|
| 13 | ~19.1 m | ~4.9 km |
| 14 | ~9.55 m | ~2.4 km |
| 15 | ~4.77 m | ~1.2 km |
| 16 | ~2.39 m | ~612 m |
| 17 | ~1.19 m | ~306 m |
| 18 | ~0.60 m | ~153 m |
| 19 | ~0.30 m | ~76 m |
| 20 | ~0.15 m | ~38 m |

**Formula:** `meters_per_pixel = 40075016.686 / (256 * 2^zoom)`

---

## How to Check Native DEM Resolution

Use `gdalinfo` to check pixel size of your source DEM:

```bash
docker run --rm -v "./data:/data:ro" ghcr.io/osgeo/gdal:alpine-small-3.12.1 \
  gdalinfo /data/source/sulawesi/DTM_MND_2417-1445C.tif | grep "Pixel Size"

# Output:
# Pixel Size = (0.000008954610000, -0.000008954610000)
```

**Convert degrees to meters (at equator):**
```
meters = degrees × 111320
0.00000895461° × 111320 = 0.997m ≈ 1m
```

Then match to the closest zoom level from the reference table above.

---

## Pipeline Resolution Settings

### 1. Tiling — `tile.sh`

| Setting | Value | Line | Notes |
|---------|-------|------|-------|
| `MAX_ZOOM` | 18 | 23 | Hard cap via `ctb-tile -s` flag - this is what actually limits zoom levels |

**Note:** No `-tr` value needed in `gdalbuildvrt`. The VRT preserves native resolution from source DEMs, and `MAX_ZOOM` enforces the zoom limit. Previously a `-tr` workaround was used but testing confirmed it's unnecessary.

### 2. Mosaic Index — `mosaic.sh`

| Setting | Value | Line | Notes |
|---------|-------|------|-------|
| `--minzoom` | 0 | 52 | Low zoom for overview tiles |
| `--maxzoom` | 18 | 52 | Maximum zoom for TiTiler/MapLibre |

### 3. MapLibre Viewer — `maplibre-terrain.html`

| Source/Component | minzoom | maxzoom | Line | Notes |
|------------------|---------|---------|------|-------|
| `DemSource` (mlcontour) | 13 | 17 | 370-378 | Client-side contour generation |
| `local-dem` (raster-dem) | 13 | 17 | 436-443 | 3D terrain extrusion |
| `local-hillshade` (raster) | 13 | 17 | 447-453 | Hillshade overlay |
| `local-slope` (raster) | 13 | 17 | 463-469 | Slope analysis overlay |
| `contour-source` (vector) | 13 | 17 | 479-494 | Vector contour tiles |
| Tile size | 256px | - | 357 | All sources use 256px tiles |

All layers aligned to maxzoom 17 to save the VPS resources, bigger VPS could use 18 just fine.

### 4. Cesium Viewer — `cesium-terrain.html`

| Setting | Value | Notes |
|---------|-------|-------|
| Terrain max level | Inherited | Reads from `layer.json` generated by `ctb-tile` in `tile.sh` |
| Base imagery max | 19 | Esri World Imagery (Overzoom) |

---

## Recommended Settings by DEM Source

| DEM Source | Native Resolution | Recommended MAX_ZOOM |
|------------|-------------------|----------------------|
| SRTM | 30m | 14 |
| ALOS PALSAR | 12.5m | 14 |
| DEMNAS BIG (5m) | 5m | 15 |
| **New BIG DEM (0.97m)** | **0.97m** | **18** |
| LiDAR (1m) | 1m | 18 |
| LiDAR (0.5m) | 0.5m | 19 |

**Note:** VRT `-tr` value is not needed. Just set `MAX_ZOOM` in `tile.sh` to cap zoom levels.

---

## Quick Reference: Files to Update When Changing DEM Source

1. **`.dem-server/scripts/tile.sh`**
   - Line 23: `MAX_ZOOM=18` (change to match your DEM's recommended zoom)

2. **`.dem-server/scripts/mosaic.sh`**
   - Line 52: `--maxzoom 18` (should match MAX_ZOOM)

3. **`.dem-server/test/maplibre-terrain.html`** - capped to 17 for VPS performance
   - Line 374: `maxzoom: 17` (DemSource) 
   - Line 442: `maxzoom: 17` (local-dem)
   - Line 452: `maxzoom: 17` (local-hillshade)
   - Line 468: `maxzoom: 17` (local-slope)
   - Line 493: `maxzoom: 17` (contour-source)

---

## Changelog

| Date | Change | DEM Source | MAX_ZOOM |
|------|--------|------------|----------|
| 2026-02-08 | Removed unnecessary VRT `-tr` flag, MAX_ZOOM is the actual cap | New BIG DEM 0.97m | 18 |
